# å®‰è£…Kubernetesé«˜å¯ç”¨
> å‚è€ƒæ–‡ç« ï¼šhttps://kuboard.cn/install/install-kubernetes.html#%E6%A3%80%E6%9F%A5-centos-hostname

> #### TIP
> æ¨èåˆå­¦è€…æŒ‰ç…§ å®‰è£…Kubernetes å•MasterèŠ‚ç‚¹ æ–‡æ¡£è¿›è¡Œ Kubernetes é›†ç¾¤æ­å»º

## ç¬¬ä¸€éƒ¨åˆ† æ¦‚è¿°
### 1.1 ä»‹ç»
kubernetes å®‰è£…æœ‰å¤šç§é€‰æ‹©ï¼Œæœ¬æ–‡æ¡£æè¿°çš„é›†ç¾¤å®‰è£…å…·å¤‡å¦‚ä¸‹ç‰¹ç‚¹ï¼š
- Kubernetes 1.16.2
    - calico 3.9
    - nginx-ingress 1.5.3
- Docker 18.09.7
- ä¸‰ä¸ª master ç»„æˆä¸»èŠ‚ç‚¹é›†ç¾¤ï¼Œé€šè¿‡å†…ç½‘ loader balancer å®ç°è´Ÿè½½å‡è¡¡ï¼›è‡³å°‘éœ€è¦ä¸‰ä¸ª master èŠ‚ç‚¹æ‰å¯ç»„æˆé«˜å¯ç”¨é›†ç¾¤ï¼Œ**å¦åˆ™ä¼šå‡ºç° è„‘è£‚ ç°è±¡**
- å¤šä¸ª worker ç»„æˆå·¥ä½œèŠ‚ç‚¹é›†ç¾¤ï¼Œé€šè¿‡å¤–ç½‘ loader balancer å®ç°è´Ÿè½½å‡è¡¡

### 1.2 æ£€æŸ¥ centos / hostname
```sh
# åœ¨ master èŠ‚ç‚¹å’Œ worker èŠ‚ç‚¹éƒ½è¦æ‰§è¡Œ
cat /etc/redhat-release

# æ­¤å¤„ hostname çš„è¾“å‡ºå°†ä¼šæ˜¯è¯¥æœºå™¨åœ¨ Kubernetes é›†ç¾¤ä¸­çš„èŠ‚ç‚¹åå­—
hostname
```
##### æ“ä½œç³»ç»Ÿå…¼å®¹æ€§

| CentOS  ç‰ˆæœ¬ | æœ¬æ–‡æ¡£æ˜¯å¦å…¼å®¹ | å¤‡æ³¨                                |
| ------------ | -------------- | ----------------------------------- |
| 7.7          | ğŸ˜„             | å·²éªŒè¯                              |
| 7.6          | ğŸ˜„             | å·²éªŒè¯                              |
| 7.5          | ğŸ˜             | å·²è¯å®ä¼šå‡ºç° kubelet æ— æ³•å¯åŠ¨çš„é—®é¢˜ |
| 7.4          | ğŸ˜             | åŒä¸Š                                |
| 7.3          | ğŸ˜             | åŒä¸Š                                |
| 7.2          | ğŸ˜             | åŒä¸Š                                |

#### ä¿®æ”¹ hostname
å¦‚æœæ‚¨éœ€è¦ä¿®æ”¹ hostnameï¼Œå¯æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤ï¼š
```sh
# ä¿®æ”¹ hostname
hostnamectl set-hostname your-new-host-name
# æŸ¥çœ‹ä¿®æ”¹ç»“æœ
hostnamectl status
# è®¾ç½® hostname è§£æ
echo "127.0.0.1   $(hostname)" >> /etc/hosts
```
### 1.3 å®‰è£… docker / kubelet
ä½¿ç”¨ root èº«ä»½åœ¨æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œå¦‚ä¸‹ä»£ç ï¼Œä»¥å®‰è£…è½¯ä»¶ï¼š
- docker
- nfs-utils
- kubectl / kubeadm / kubelet

#### å¿«é€Ÿå®‰è£…
```sh
# åœ¨ master èŠ‚ç‚¹å’Œ worker èŠ‚ç‚¹éƒ½è¦æ‰§è¡Œ
curl -sSL https://kuboard.cn/install-script/v1.16.2/install_kubelet.sh | sh
```
#### æ‰‹åŠ¨å®‰è£…
```sh
#!/bin/bash

# åœ¨ master èŠ‚ç‚¹å’Œ worker èŠ‚ç‚¹éƒ½è¦æ‰§è¡Œ

# å®‰è£… docker
# å‚è€ƒæ–‡æ¡£å¦‚ä¸‹
# https://docs.docker.com/install/linux/docker-ce/centos/
# https://docs.docker.com/install/linux/linux-postinstall/

# å¸è½½æ—§ç‰ˆæœ¬
yum remove -y docker \
docker-client \
docker-client-latest \
docker-common \
docker-latest \
docker-latest-logrotate \
docker-logrotate \
docker-selinux \
docker-engine-selinux \
docker-engine

# è®¾ç½® yum repository
yum install -y yum-utils \
device-mapper-persistent-data \
lvm2
yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo

# å®‰è£…å¹¶å¯åŠ¨ docker
yum install -y docker-ce-18.09.7 docker-ce-cli-18.09.7 containerd.io
systemctl enable docker
systemctl start docker

# å®‰è£… nfs-utils
# å¿…é¡»å…ˆå®‰è£… nfs-utils æ‰èƒ½æŒ‚è½½ nfs ç½‘ç»œå­˜å‚¨
yum install -y nfs-utils
yum install -y wget

# å…³é—­ é˜²ç«å¢™
systemctl stop firewalld
systemctl disable firewalld

# å…³é—­ SeLinux
setenforce 0
sed -i "s/SELINUX=enforcing/SELINUX=disabled/g" /etc/selinux/config

# å…³é—­ swap
swapoff -a
yes | cp /etc/fstab /etc/fstab_bak
cat /etc/fstab_bak |grep -v swap > /etc/fstab

# ä¿®æ”¹ /etc/sysctl.conf
# å¦‚æœæœ‰é…ç½®ï¼Œåˆ™ä¿®æ”¹
sed -i "s#^net.ipv4.ip_forward.*#net.ipv4.ip_forward=1#g"  /etc/sysctl.conf
sed -i "s#^net.bridge.bridge-nf-call-ip6tables.*#net.bridge.bridge-nf-call-ip6tables=1#g"  /etc/sysctl.conf
sed -i "s#^net.bridge.bridge-nf-call-iptables.*#net.bridge.bridge-nf-call-iptables=1#g"  /etc/sysctl.conf
# å¯èƒ½æ²¡æœ‰ï¼Œè¿½åŠ 
echo "net.ipv4.ip_forward = 1" >> /etc/sysctl.conf
echo "net.bridge.bridge-nf-call-ip6tables = 1" >> /etc/sysctl.conf
echo "net.bridge.bridge-nf-call-iptables = 1" >> /etc/sysctl.conf
# æ‰§è¡Œå‘½ä»¤ä»¥åº”ç”¨
sysctl -p

# é…ç½®K8Sçš„yumæº
cat <<EOF > /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=0
repo_gpgcheck=0
gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg
       http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF

# å¸è½½æ—§ç‰ˆæœ¬
yum remove -y kubelet kubeadm kubectl

# å®‰è£…kubeletã€kubeadmã€kubectl
yum install -y kubelet-1.16.2 kubeadm-1.16.2 kubectl-1.16.2

# ä¿®æ”¹docker Cgroup Driverä¸ºsystemd
# # å°†/usr/lib/systemd/system/docker.serviceæ–‡ä»¶ä¸­çš„è¿™ä¸€è¡Œ ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock
# # ä¿®æ”¹ä¸º ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --exec-opt native.cgroupdriver=systemd
# å¦‚æœä¸ä¿®æ”¹ï¼Œåœ¨æ·»åŠ  worker èŠ‚ç‚¹æ—¶å¯èƒ½ä¼šç¢°åˆ°å¦‚ä¸‹é”™è¯¯
# [WARNING IsDockerSystemdCheck]: detected "cgroupfs" as the Docker cgroup driver. The recommended driver is "systemd".
# Please follow the guide at https://kubernetes.io/docs/setup/cri/
sed -i "s#^ExecStart=/usr/bin/dockerd.*#ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --exec-opt native.cgroupdriver=systemd#g" /usr/lib/systemd/system/docker.service

# è®¾ç½® docker é•œåƒï¼Œæé«˜ docker é•œåƒä¸‹è½½é€Ÿåº¦å’Œç¨³å®šæ€§
# å¦‚æœæ‚¨è®¿é—® https://hub.docker.io é€Ÿåº¦éå¸¸ç¨³å®šï¼Œäº¦å¯ä»¥è·³è¿‡è¿™ä¸ªæ­¥éª¤
curl -sSL https://get.daocloud.io/daotools/set_mirror.sh | sh -s http://f1361db2.m.daocloud.io

# é‡å¯ dockerï¼Œå¹¶å¯åŠ¨ kubelet
systemctl daemon-reload
systemctl restart docker
systemctl enable kubelet && systemctl start kubelet

docker version
```
### 1.4 åˆå§‹åŒ–API Server
#### åˆ›å»º ApiServer çš„ Load Balancerï¼ˆç§ç½‘ï¼‰
ç›‘å¬ç«¯å£ï¼š6443 / TCP

åç«¯èµ„æºç»„ï¼šåŒ…å« demo-master-a-1, demo-master-a-2, demo-master-a-3

åç«¯ç«¯å£ï¼š6443

å¼€å¯ æŒ‰æºåœ°å€ä¿æŒä¼šè¯

å‡è®¾å®Œæˆåˆ›å»ºä»¥åï¼ŒLoad Balancerçš„ ip åœ°å€ä¸º x.x.x.x
> æ ¹æ®æ¯ä¸ªäººå®é™…çš„æƒ…å†µä¸åŒï¼Œå®ç° LoadBalancer çš„æ–¹å¼ä¸ä¸€æ ·ï¼Œæœ¬æ–‡ä¸è¯¦ç»†é˜è¿°å¦‚ä½•æ­å»º LoadBalancerï¼Œè¯·è¯»è€…è‡ªè¡Œè§£å†³ï¼Œå¯ä»¥è€ƒè™‘çš„é€‰æ‹©æœ‰ï¼š
> - nginx
> - haproxy
> - keepalived
> - äº‘ä¾›åº”å•†æä¾›çš„è´Ÿè½½å‡è¡¡äº§å“

## ç¬¬äºŒéƒ¨ å¼€å§‹éƒ¨ç½²
### 2.1 åˆå§‹åŒ–ç¬¬ä¸€ä¸ªmasterèŠ‚ç‚¹
> #### TIP
> - ä»¥ root èº«ä»½åœ¨ demo-master-a-1 æœºå™¨ä¸Šæ‰§è¡Œ
> - åˆå§‹åŒ– master èŠ‚ç‚¹æ—¶ï¼Œå¦‚æœå› ä¸ºä¸­é—´æŸäº›æ­¥éª¤çš„é…ç½®å‡ºé”™ï¼Œæƒ³è¦é‡æ–°åˆå§‹åŒ– master èŠ‚ç‚¹ï¼Œè¯·å…ˆæ‰§è¡Œ kubeadm reset æ“ä½œ

> #### å…³äºåˆå§‹åŒ–æ—¶ç”¨åˆ°çš„ç¯å¢ƒå˜é‡
> - **APISERVER_NAME** ä¸èƒ½æ˜¯ master çš„ hostname
> - **APISERVER_NAME** å¿…é¡»å…¨ä¸ºå°å†™å­—æ¯ã€æ•°å­—ã€å°æ•°ç‚¹ï¼Œä¸èƒ½åŒ…å«å‡å·
> - **POD_SUBNET** æ‰€ä½¿ç”¨çš„ç½‘æ®µä¸èƒ½ä¸ masterèŠ‚ç‚¹/workerèŠ‚ç‚¹ æ‰€åœ¨çš„ç½‘æ®µé‡å ã€‚è¯¥å­—æ®µçš„å–å€¼ä¸ºä¸€ä¸ª CIDR å€¼ï¼Œå¦‚æœæ‚¨å¯¹ CIDR è¿™ä¸ªæ¦‚å¿µè¿˜ä¸ç†Ÿæ‚‰ï¼Œè¯·ä¸è¦ä¿®æ”¹è¿™ä¸ªå­—æ®µçš„å–å€¼ 10.100.0.1/16

#### å¿«é€Ÿåˆå§‹åŒ–
```sh
# åªåœ¨ç¬¬ä¸€ä¸ª master èŠ‚ç‚¹æ‰§è¡Œ
# æ›¿æ¢ apiserver.demo ä¸º æ‚¨æƒ³è¦çš„ dnsName
export APISERVER_NAME=apiserver.demo
# Kubernetes å®¹å™¨ç»„æ‰€åœ¨çš„ç½‘æ®µï¼Œè¯¥ç½‘æ®µå®‰è£…å®Œæˆåï¼Œç”± kubernetes åˆ›å»ºï¼Œäº‹å…ˆå¹¶ä¸å­˜åœ¨äºæ‚¨çš„ç‰©ç†ç½‘ç»œä¸­
export POD_SUBNET=10.100.0.1/16
echo "127.0.0.1    ${APISERVER_NAME}" >> /etc/hosts
curl -sSL https://kuboard.cn/install-script/v1.16.2/init_master.sh | sh
```
#### æ‰‹åŠ¨åˆå§‹åŒ–
```sh
# åªåœ¨ç¬¬ä¸€ä¸ª master èŠ‚ç‚¹æ‰§è¡Œ
# æ›¿æ¢ apiserver.demo ä¸º æ‚¨æƒ³è¦çš„ dnsName
export APISERVER_NAME=apiserver.demo
# Kubernetes å®¹å™¨ç»„æ‰€åœ¨çš„ç½‘æ®µï¼Œè¯¥ç½‘æ®µå®‰è£…å®Œæˆåï¼Œç”± kubernetes åˆ›å»ºï¼Œäº‹å…ˆå¹¶ä¸å­˜åœ¨äºæ‚¨çš„ç‰©ç†ç½‘ç»œä¸­
export POD_SUBNET=10.100.0.1/16
echo "127.0.0.1    ${APISERVER_NAME}" >> /etc/hosts
```
```sh
#!/bin/bash

# åªåœ¨ master èŠ‚ç‚¹æ‰§è¡Œ

# è„šæœ¬å‡ºé”™æ—¶ç»ˆæ­¢æ‰§è¡Œ
set -e

# æŸ¥çœ‹å®Œæ•´é…ç½®é€‰é¡¹ https://godoc.org/k8s.io/kubernetes/cmd/kubeadm/app/apis/kubeadm/v1beta2
rm -f ./kubeadm-config.yaml
cat <<EOF > ./kubeadm-config.yaml
apiVersion: kubeadm.k8s.io/v1beta2
kind: ClusterConfiguration
kubernetesVersion: v1.16.2
imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers
controlPlaneEndpoint: "${APISERVER_NAME}:6443"
networking:
  serviceSubnet: "10.96.0.0/16"
  podSubnet: "${POD_SUBNET}"
  dnsDomain: "cluster.local"
EOF

# kubeadm init
# æ ¹æ®æ‚¨æœåŠ¡å™¨ç½‘é€Ÿçš„æƒ…å†µï¼Œæ‚¨éœ€è¦ç­‰å€™ 3 - 10 åˆ†é’Ÿ
kubeadm init --config=kubeadm-config.yaml --upload-certs

# é…ç½® kubectl
rm -rf /root/.kube/
mkdir /root/.kube/
cp -i /etc/kubernetes/admin.conf /root/.kube/config

# å®‰è£… calico ç½‘ç»œæ’ä»¶
# å‚è€ƒæ–‡æ¡£ https://docs.projectcalico.org/v3.9/getting-started/kubernetes/
rm -f calico-3.9.2.yaml
wget https://kuboard.cn/install-script/calico/calico-3.9.2.yaml
sed -i "s#192\.168\.0\.0/16#${POD_SUBNET}#" calico-3.9.2.yaml
kubectl apply -f calico-3.9.2.yaml
```
#### æ‰§è¡Œç»“æœ
æ‰§è¡Œç»“æœä¸­ï¼š
- ç¬¬15ã€16ã€17è¡Œï¼Œç”¨äºåˆå§‹åŒ–ç¬¬äºŒã€ä¸‰ä¸ª master èŠ‚ç‚¹
- ç¬¬25ã€26è¡Œï¼Œç”¨äºåˆå§‹åŒ– worker èŠ‚ç‚¹

```sh
Your Kubernetes control-plane has initialized successfully!

To start using your cluster, you need to run the following as a regular user:

  mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config

You should now deploy a pod network to the cluster.
Run "kubectl apply -f [podnetwork].yaml" with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

You can now join any number of the control-plane node running the following command on each as root:

  kubeadm join apiserver.k8s:6443 --token 4z3r2v.2p43g28ons3b475v \
    --discovery-token-ca-cert-hash sha256:959569cbaaf0cf3fad744f8bd8b798ea9e11eb1e568c15825355879cf4cdc5d6 \
    --control-plane --certificate-key 41a741533a038a936759aff43b5680f0e8c41375614a873ea49fde8944614dd6

Please note that the certificate-key gives access to cluster sensitive data, keep it secret!
As a safeguard, uploaded-certs will be deleted in two hours; If necessary, you can use
"kubeadm init phase upload-certs --upload-certs" to reload certs afterward.

Then you can join any number of worker nodes by running the following on each as root:

kubeadm join apiserver.k8s:6443 --token 4z3r2v.2p43g28ons3b475v \
    --discovery-token-ca-cert-hash sha256:959569cbaaf0cf3fad744f8bd8b798ea9e11eb1e568c15825355879cf4cdc5d6
```
#### æ£€æŸ¥ master åˆå§‹åŒ–ç»“æœ
```sh
# åªåœ¨ç¬¬ä¸€ä¸ª master èŠ‚ç‚¹æ‰§è¡Œ

# æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œç­‰å¾… 3-10 åˆ†é’Ÿï¼Œç›´åˆ°æ‰€æœ‰çš„å®¹å™¨ç»„å¤„äº Running çŠ¶æ€
watch kubectl get pod -n kube-system -o wide

# æŸ¥çœ‹ master èŠ‚ç‚¹åˆå§‹åŒ–ç»“æœ
kubectl get nodes
```
> #### WARNING
> **è¯·ç­‰åˆ°æ‰€æœ‰å®¹å™¨ç»„ï¼ˆå¤§çº¦9ä¸ªï¼‰å…¨éƒ¨å¤„äº Running çŠ¶æ€ï¼Œæ‰è¿›è¡Œä¸‹ä¸€æ­¥**

### 2.2 åˆå§‹åŒ–ç¬¬äºŒã€ä¸‰ä¸ªmasterèŠ‚ç‚¹
è·å¾— master èŠ‚ç‚¹çš„ join å‘½ä»¤
> å¯ä»¥å’Œç¬¬ä¸€ä¸ªMasterèŠ‚ç‚¹ä¸€èµ·åˆå§‹åŒ–ç¬¬äºŒã€ä¸‰ä¸ªMasterèŠ‚ç‚¹ï¼Œä¹Ÿå¯ä»¥ä»å•MasterèŠ‚ç‚¹è°ƒæ•´è¿‡æ¥ï¼Œåªéœ€è¦
> - å¢åŠ Masterçš„ LoadBalancer
> - å°†æ‰€æœ‰èŠ‚ç‚¹çš„ /etc/hosts æ–‡ä»¶ä¸­ apiserver.demo è§£æä¸º LoadBalancer çš„åœ°å€
> - æ·»åŠ ç¬¬äºŒã€ä¸‰ä¸ªMasterèŠ‚ç‚¹
> - åˆå§‹åŒ– master èŠ‚ç‚¹çš„ token æœ‰æ•ˆæ—¶é—´ä¸º 2 å°æ—¶

#### å’Œç¬¬ä¸€ä¸ªMaster èŠ‚ç‚¹ä¸€èµ·åˆå§‹åŒ–
åˆå§‹åŒ–ç¬¬ä¸€ä¸ª master èŠ‚ç‚¹æ—¶çš„è¾“å‡ºå†…å®¹ä¸­ï¼Œç¬¬15ã€16ã€17è¡Œå°±æ˜¯ç”¨æ¥åˆå§‹åŒ–ç¬¬äºŒã€ä¸‰ä¸ª master èŠ‚ç‚¹çš„å‘½ä»¤ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š**æ­¤æ—¶è¯·ä¸è¦æ‰§è¡Œè¯¥å‘½ä»¤**
```sh
kubeadm join apiserver.k8s:6443 --token 4z3r2v.2p43g28ons3b475v \
  --discovery-token-ca-cert-hash sha256:959569cbaaf0cf3fad744f8bd8b798ea9e11eb1e568c15825355879cf4cdc5d6 \
  --control-plane --certificate-key 41a741533a038a936759aff43b5680f0e8c41375614a873ea49fde8944614dd6
```
#### ç¬¬ä¸€ä¸ªMaster èŠ‚ç‚¹åˆå§‹åŒ– ä¸¤ä¸ªå°æ—¶ å å†åˆå§‹åŒ–
#### a. è·å¾— certificate key
åœ¨ demo-master-a-1 ä¸Šæ‰§è¡Œ
```sh
# åªåœ¨ ç¬¬ä¸€ä¸ª master èŠ‚ç‚¹ demo-master-a-1 ä¸Šæ‰§è¡Œ
kubeadm init phase upload-certs --upload-certs
```
è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š

```sh
[root@demo-master-a-1 ~]# kubeadm init phase upload-certs --upload-certs
W0902 09:05:28.355623    1046 version.go:98] could not fetch a Kubernetes version from the internet: unable to get URL "https://dl.k8s.io/release/stable-1.txt": Get https://dl.k8s.io/release/stable-1.txt: net/http: request canceled while waiting for connection (Client.Timeout exceeded while awaiting headers)
W0902 09:05:28.355718    1046 version.go:99] falling back to the local client version: v1.16.2
[upload-certs] Storing the certificates in Secret "kubeadm-certs" in the "kube-system" Namespace
[upload-certs] Using certificate key:
70eb87e62f052d2d5de759969d5b42f372d0ad798f98df38f7fe73efdf63a13c
```

#### b.è·å¾— join å‘½ä»¤
åœ¨ demo-master-a-1 ä¸Šæ‰§è¡Œ
```sh
# åªåœ¨ ç¬¬ä¸€ä¸ª master èŠ‚ç‚¹ demo-master-a-1 ä¸Šæ‰§è¡Œ
kubeadm token create --print-join-command
```
è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š
```sh
[root@demo-master-a-1 ~]# kubeadm token create --print-join-command
kubeadm join apiserver.demo:6443 --token bl80xo.hfewon9l5jlpmjft     --discovery-token-ca-cert-hash sha256:b4d2bed371fe4603b83e7504051dcfcdebcbdcacd8be27884223c4ccc13059a4
```
åˆ™ï¼Œç¬¬äºŒã€ä¸‰ä¸ª master èŠ‚ç‚¹çš„ join å‘½ä»¤å¦‚ä¸‹ï¼š
- å‘½ä»¤è¡Œä¸­ï¼Œè“è‰²éƒ¨åˆ†æ¥è‡ªäºå‰é¢è·å¾—çš„ join å‘½ä»¤ï¼Œçº¢è‰²éƒ¨åˆ†æ¥è‡ªäºå‰é¢è·å¾—çš„ certificate key

```sh
kubeadm join apiserver.demo:6443 --token ejwx62.vqwog6il5p83uk7y \
--discovery-token-ca-cert-hash sha256:6f7a8e40a810323672de5eee6f4d19aa2dbdb38411845a1bf5dd63485c43d303 \
--control-plane --certificate-key 70eb87e62f052d2d5de759969d5b42f372d0ad798f98df38f7fe73efdf63a13c
```

### 2.2.1 åˆå§‹åŒ–ç¬¬äºŒã€ä¸‰ä¸ª master èŠ‚ç‚¹
åœ¨ demo-master-b-1 å’Œ demo-master-b-2 æœºå™¨ä¸Šæ‰§è¡Œ
```sh
# åªåœ¨ç¬¬äºŒã€ä¸‰ä¸ª master èŠ‚ç‚¹ demo-master-b-1 å’Œ demo-master-b-2 æ‰§è¡Œ
# æ›¿æ¢ x.x.x.x ä¸º ApiServer LoadBalancer çš„ IP åœ°å€
export APISERVER_IP=x.x.x.x
# æ›¿æ¢ apiserver.demo ä¸º å‰é¢å·²ç»ä½¿ç”¨çš„ dnsName
export APISERVER_NAME=apiserver.demo
echo "${APISERVER_IP}    ${APISERVER_NAME}" >> /etc/hosts
# ä½¿ç”¨å‰é¢æ­¥éª¤ä¸­è·å¾—çš„ç¬¬äºŒã€ä¸‰ä¸ª master èŠ‚ç‚¹çš„ join å‘½ä»¤
kubeadm join apiserver.demo:6443 --token ejwx62.vqwog6il5p83uk7y \
--discovery-token-ca-cert-hash sha256:6f7a8e40a810323672de5eee6f4d19aa2dbdb38411845a1bf5dd63485c43d303 \
--control-plane --certificate-key 70eb87e62f052d2d5de759969d5b42f372d0ad798f98df38f7fe73efdf63a13c
```
> #### å¸¸è§é—®é¢˜
> å¦‚æœä¸€ç›´åœç•™åœ¨ pre-flight çŠ¶æ€ï¼Œè¯·åœ¨ç¬¬äºŒã€ä¸‰ä¸ªèŠ‚ç‚¹ä¸Šæ‰§è¡Œå‘½ä»¤æ£€æŸ¥ï¼š
```sh
curl -ik https://apiserver.demo:6443/version
```
> è¾“å‡ºç»“æœåº”è¯¥å¦‚ä¸‹æ‰€ç¤º
```sh
HTTP/1.1 200 OK
Cache-Control: no-cache, private
Content-Type: application/json
Date: Wed, 30 Oct 2019 08:13:39 GMT
Content-Length: 263
{
  "major": "1",
  "minor": "16",
  "gitVersion": "v1.16.2",
  "gitCommit": "2bd9643cee5b3b3a5ecbd3af49d09018f0773c77",
  "gitTreeState": "clean",
  "buildDate": "2019-09-18T14:27:17Z",
  "goVersion": "go1.12.9",
  "compiler": "gc",
  "platform": "linux/amd64"
}
```
> å¦åˆ™ï¼Œè¯·æ‚¨æ£€æŸ¥ä¸€ä¸‹æ‚¨çš„ Loadbalancer æ˜¯å¦è®¾ç½®æ­£ç¡®

#### æ£€æŸ¥ master åˆå§‹åŒ–ç»“æœ
```sh
# åªåœ¨ç¬¬ä¸€ä¸ª master èŠ‚ç‚¹ demo-master-a-1 æ‰§è¡Œ
# æŸ¥çœ‹ master èŠ‚ç‚¹åˆå§‹åŒ–ç»“æœ
kubectl get nodes
```
### 2.3 #åˆå§‹åŒ– workerèŠ‚ç‚¹
#### è·å¾— joinå‘½ä»¤å‚æ•°
åˆå§‹åŒ–ç¬¬ä¸€ä¸ª master èŠ‚ç‚¹æ—¶çš„è¾“å‡ºå†…å®¹ä¸­ï¼Œç¬¬25ã€26è¡Œå°±æ˜¯ç”¨æ¥åˆå§‹åŒ– worker èŠ‚ç‚¹çš„å‘½ä»¤ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š**æ­¤æ—¶è¯·ä¸è¦æ‰§è¡Œè¯¥å‘½ä»¤**
#### a. å’Œç¬¬ä¸€ä¸ªMasterèŠ‚ç‚¹ä¸€èµ·åˆå§‹åŒ–
```sh
kubeadm join apiserver.k8s:6443 --token 4z3r2v.2p43g28ons3b475v \
  --discovery-token-ca-cert-hash sha256:959569cbaaf0cf3fad744f8bd8b798ea9e11eb1e568c15825355879cf4cdc5d6
```
#### b. ç¬¬ä¸€ä¸ªmasterèŠ‚ç‚¹åˆå§‹åŒ–2ä¸ªå°æ—¶å€™å†è¿›è¡Œåˆå§‹åŒ–
åœ¨ç¬¬ä¸€ä¸ª master èŠ‚ç‚¹ demo-master-a-1 èŠ‚ç‚¹æ‰§è¡Œ
```sh
# åªåœ¨ç¬¬ä¸€ä¸ª master èŠ‚ç‚¹ demo-master-a-1 ä¸Šæ‰§è¡Œ
kubeadm token create --print-join-command
```
å¯è·å–kubeadm join å‘½ä»¤åŠå‚æ•°ï¼Œå¦‚ä¸‹æ‰€ç¤º
```sh
kubeadm join apiserver.demo:6443 --token mpfjma.4vjjg8flqihor4vt     --discovery-token-ca-cert-hash sha256:6f7a8e40a810323672de5eee6f4d19aa2dbdb38411845a1bf5dd63485c43d303
```

> #### æœ‰æ•ˆæ—¶é—´
> è¯¥ token çš„æœ‰æ•ˆæ—¶é—´ä¸º 2 ä¸ªå°æ—¶ï¼Œ2å°æ—¶å†…ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨æ­¤ token åˆå§‹åŒ–ä»»æ„æ•°é‡çš„ worker èŠ‚ç‚¹ã€‚

### 2.3.1 åˆå§‹åŒ–worker
é’ˆå¯¹æ‰€æœ‰çš„ worker èŠ‚ç‚¹æ‰§è¡Œ
```sh
# åªåœ¨ worker èŠ‚ç‚¹æ‰§è¡Œ
# æ›¿æ¢ x.x.x.x ä¸º ApiServer LoadBalancer çš„ IP åœ°å€
export MASTER_IP=x.x.x.x
# æ›¿æ¢ apiserver.demo ä¸ºåˆå§‹åŒ– master èŠ‚ç‚¹æ—¶æ‰€ä½¿ç”¨çš„ APISERVER_NAME
export APISERVER_NAME=apiserver.demo
echo "${MASTER_IP}    ${APISERVER_NAME}" >> /etc/hosts

# æ›¿æ¢ä¸ºå‰é¢ kubeadm token create --print-join-command çš„è¾“å‡ºç»“æœ
kubeadm join apiserver.demo:6443 --token mpfjma.4vjjg8flqihor4vt     --discovery-token-ca-cert-hash sha256:6f7a8e40a810323672de5eee6f4d19aa2dbdb38411845a1bf5dd63485c43d303
````
#### æ£€æŸ¥ worker åˆå§‹åŒ–ç»“æœ
åœ¨ç¬¬ä¸€ä¸ªmasterèŠ‚ç‚¹ demo-master-a-1 ä¸Šæ‰§è¡Œ
```sh
# åªåœ¨ç¬¬ä¸€ä¸ª master èŠ‚ç‚¹ demo-master-a-1 ä¸Šæ‰§è¡Œ
kubectl get nodes
```
### 2.4 ç§»é™¤ worker èŠ‚ç‚¹
> WARNING: æ­£å¸¸æƒ…å†µä¸‹ï¼Œæ‚¨æ— éœ€ç§»é™¤ worker èŠ‚ç‚¹

åœ¨å‡†å¤‡ç§»é™¤çš„ worker èŠ‚ç‚¹ä¸Šæ‰§è¡Œ
```sh
kubeadm reset
```
åœ¨ç¬¬ä¸€ä¸ª master èŠ‚ç‚¹ demo-master-a-1 ä¸Šæ‰§è¡Œ
```sh
kubectl delete node demo-worker-x-x
```
> - å°† demo-worker-x-x æ›¿æ¢ä¸ºè¦ç§»é™¤çš„ worker èŠ‚ç‚¹çš„åå­—
> - worker èŠ‚ç‚¹çš„åå­—å¯ä»¥é€šè¿‡åœ¨ç¬¬ä¸€ä¸ª master èŠ‚ç‚¹ demo-master-a-1 ä¸Šæ‰§è¡Œ kubectl get nodes å‘½ä»¤è·å¾—


### 2.4 å®‰è£… Ingress Controller
> - **Ingresså®˜æ–¹æ–‡æ¡£**ï¼šhttps://kubernetes.io/docs/concepts/services-networking/ingress/
> - **Ingress Controllerså®˜ç½‘ä»‹ç»**ï¼šhttps://kubernetes.io/docs/concepts/services-networking/ingress-controllers/
> - **æœ¬æ–‡ä¸­ä½¿ç”¨å¦‚ä¸‹éƒ¨ç½²æ–¹å¼**ï¼šhttps://kubernetes.github.io/ingress-nginx/deploy/baremetal/#using-a-self-provisioned-edge
> - **kubernetesæ”¯æŒå¤šç§Ingress Controllers (traefic / Kong / Istio / Nginx ç­‰)**ï¼Œæœ¬æ–‡æ¨èä½¿ç”¨ https://github.com/nginxinc/kubernetes-ingress

å…·ä½“çš„å®‰è£… è§ ä¸Šä¸€ç¯‡æ–‡ç« 

















-
