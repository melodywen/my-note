# go module è®²è§£
> å‚è€ƒæ–‡ç« ï¼š
> 1. https://juejin.im/post/5c8e503a6fb9a070d878184a
> 2. https://segmentfault.com/a/1190000016703769

go modules æ˜¯ golang 1.11 æ–°åŠ çš„ç‰¹æ€§ã€‚ç°åœ¨1.12 å·²ç»å‘å¸ƒäº†ï¼Œæ˜¯æ—¶å€™ç”¨èµ·æ¥äº†ã€‚Moduleså®˜æ–¹å®šä¹‰ä¸ºï¼š

> æ¨¡å—æ˜¯ç›¸å…³GoåŒ…çš„é›†åˆã€‚modulesæ˜¯æºä»£ç äº¤æ¢å’Œç‰ˆæœ¬æ§åˆ¶çš„å•å…ƒã€‚ goå‘½ä»¤ç›´æ¥æ”¯æŒä½¿ç”¨modulesï¼ŒåŒ…æ‹¬è®°å½•å’Œè§£æå¯¹å…¶ä»–æ¨¡å—çš„ä¾èµ–æ€§ã€‚modulesæ›¿æ¢æ—§çš„åŸºäºGOPATHçš„æ–¹æ³•æ¥æŒ‡å®šåœ¨ç»™å®šæ„å»ºä¸­ä½¿ç”¨å“ªäº›æºæ–‡ä»¶ã€‚

#### å¸¸è§çš„åŒ…ç®¡ç†å·¥å…·
- govendor
- dep
- glide
- godep

è¿™äº›åŒ…ç®¡ç†å·¥å…·éƒ½æ˜¯åŸºäº`GOPATH`æˆ–è€…`vendor`ç›®å½•ï¼Œå¹¶ä¸èƒ½å¾ˆå¥½çš„è§£å†³ä¸åŒç‰ˆæœ¬ä¾èµ–é—®é¢˜ã€‚Modulesæ˜¯åœ¨`GOPATH`ä¹‹å¤–ä¸€å¥—æ–°çš„åŒ…ç®¡ç†æ–¹å¼ã€‚

## ç¬¬ä¸€éƒ¨åˆ† æ³›è¿°

### 1.1 å¦‚ä½•æ¿€æ´»Modules
é¦–å…ˆè¦æŠŠgoå‡çº§åˆ°1.11ã€‚

å‡çº§åï¼Œå¯ä»¥è®¾ç½®é€šè¿‡ä¸€ä¸ªç¯å¢ƒå˜é‡GO111MODULEæ¥æ¿€æ´»modulesï¼š

- `GO111MODULE=off`: goå‘½ä»¤è¡Œå°†ä¸ä¼šæ”¯æŒmoduleåŠŸèƒ½;
    - å¯»æ‰¾ä¾èµ–åŒ…çš„æ–¹å¼å°†ä¼šæ²¿ç”¨æ—§ç‰ˆæœ¬é‚£ç§é€šè¿‡vendorç›®å½•æˆ–è€…GOPATHæ¨¡å¼æ¥æŸ¥æ‰¾ã€‚


- `GO111MODULE=on`: goå‘½ä»¤è¡Œä¼šä½¿ç”¨modulesï¼Œè€Œä¸€ç‚¹ä¹Ÿä¸ä¼šå»GOPATHç›®å½•ä¸‹æŸ¥æ‰¾ã€‚

- `GO111MODULE=auto`: é»˜è®¤å€¼ï¼Œgoå‘½ä»¤è¡Œå°†ä¼šæ ¹æ®å½“å‰ç›®å½•æ¥å†³å®šæ˜¯å¦å¯ç”¨moduleåŠŸèƒ½ã€‚
    - è¿™ç§æƒ…å†µä¸‹å¯ä»¥åˆ†ä¸ºä¸¤ç§æƒ…å½¢ï¼šå½“å‰ç›®å½•åœ¨GOPATH/srcä¹‹å¤–ä¸”è¯¥ç›®å½•åŒ…å«go.modæ–‡ä»¶ï¼Œæˆ–è€…å½“å‰æ–‡ä»¶åœ¨åŒ…å«go.modæ–‡ä»¶çš„ç›®å½•ä¸‹é¢ã€‚

å½“moduleåŠŸèƒ½å¯ç”¨æ—¶ï¼Œ`GOPATH`åœ¨é¡¹ç›®æ„å»ºè¿‡ç¨‹ä¸­ä¸å†æ‹…å½“`import`çš„è§’è‰²ï¼Œä½†å®ƒä»ç„¶å­˜å‚¨ä¸‹è½½çš„ä¾èµ–åŒ…ï¼Œå…·ä½“ä½ç½®åœ¨`$GOPATH/pkg/mod`;

### 1.2 go help modï¼›
```
â•°â”€â—‹ go help mod
Go mod provides access to operations on modules.

Note that support for modules is built into all the go commands,
not just 'go mod'. For example, day-to-day adding, removing, upgrading,
and downgrading of dependencies should be done using 'go get'.
See 'go help modules' for an overview of module functionality.

Usage:

	go mod <command> [arguments]

The commands are:

	download    download modules to local cache
	edit        edit go.mod from tools or scripts
	graph       print module requirement graph
	init        initialize new module in current directory
	tidy        add missing and remove unused modules
	vendor      make vendored copy of dependencies
	verify      verify dependencies have expected content
	why         explain why packages or modules are needed

Use "go help mod <command>" for more information about a command.
```
### 1.3 Go module proxy
`go get`å‘½ä»¤é»˜è®¤æƒ…å†µä¸‹ï¼Œæ— è®ºæ˜¯åœ¨`gopath mode`è¿˜æ˜¯`module-aware mode`ï¼Œéƒ½æ˜¯ç›´æ¥ä»`vcs`æœåŠ¡(æ¯”å¦‚githubã€gitlabç­‰)ä¸‹è½½moduleçš„ã€‚ä½†æ˜¯Go 1.11ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾ç½®`GOPROXY`ç¯å¢ƒå˜é‡æ¥åšä¸€äº›æ”¹å˜ï¼šè®©Goå‘½ä»¤ä»å…¶ä»–åœ°æ–¹ä¸‹è½½`module`ã€‚æ¯”å¦‚ï¼š
```
export GOPROXY=https://goproxy.io
```
### 1.4 go.mod çš„å››ä¸ªæŒ‡ä»¤
> go.mod æä¾›äº†module, requireã€replaceå’Œexclude å››ä¸ªå‘½ä»¤

- `module`: è¯­å¥æŒ‡å®šåŒ…çš„åå­—ï¼ˆè·¯å¾„ï¼‰
- `require`: è¯­å¥æŒ‡å®šçš„ä¾èµ–é¡¹æ¨¡å—
- `replace`: è¯­å¥å¯ä»¥æ›¿æ¢ä¾èµ–é¡¹æ¨¡å—
- `exclude`: è¯­å¥å¯ä»¥å¿½ç•¥ä¾èµ–é¡¹æ¨¡å—

## ç¬¬äºŒéƒ¨åˆ† å¦‚ä½•åœ¨é¡¹ç›®ä¸­ä½¿ç”¨

### 2.1 åˆ›å»ºä¸€ä¸ªæ–°çš„é¡¹ç›® (åˆå§‹åŒ– module)
> åœ¨`GOPATH`ç›®å½•ä¹‹å¤–æ–°å»ºä¸€ä¸ªç›®å½•ï¼Œå¹¶ä½¿ç”¨`go mod init `åˆå§‹åŒ–ç”Ÿæˆgo.mod æ–‡ä»¶

```
âœ  ~ mkdir hello
âœ  ~ cd hello
âœ  hello go mod init hello
go: creating new go.mod: module hello
âœ  hello ls
go.mod
âœ  hello cat go.mod
module hello

go 1.12
```

#### ç‰¹åˆ«æ³¨æ„
**`go.mod`æ–‡ä»¶ä¸€æ—¦åˆ›å»ºåï¼Œå®ƒçš„å†…å®¹å°†ä¼šè¢«`go toolchain`å…¨é¢æŒæ§ã€‚`go toolchain`ä¼šåœ¨å„ç±»å‘½ä»¤æ‰§è¡Œæ—¶ï¼Œæ¯”å¦‚go getã€go buildã€go modç­‰ä¿®æ”¹å’Œç»´æŠ¤`go.mod`æ–‡ä»¶**ã€‚

### 2.2 æ·»åŠ ä¾èµ–
æ–°å»ºä¸€ä¸ª `server.go` æ–‡ä»¶ï¼Œå†™å…¥ä»¥ä¸‹ä»£ç ï¼š

```
package main

import (
	"net/http"

	"github.com/labstack/echo"
)

func main() {
	e := echo.New()
	e.GET("/", func(c echo.Context) error {
		return c.String(http.StatusOK, "Hello, World!")
	})
	e.Logger.Fatal(e.Start(":1323"))
}
```
æ‰§è¡Œ `go run server.go` è¿è¡Œä»£ç ä¼šå‘ç° `go mod` ä¼šè‡ªåŠ¨æŸ¥æ‰¾ä¾èµ–è‡ªåŠ¨ä¸‹è½½ï¼š
```
$ go run server.go
go: finding github.com/labstack/echo v3.3.10+incompatible
go: downloading github.com/labstack/echo v3.3.10+incompatible
go: extracting github.com/labstack/echo v3.3.10+incompatible
# æ­¤å¤„çœç•¥å¾ˆå¤šè¡Œ
...
   ____    __
  / __/___/ /  ___
 / _// __/ _ \/ _ \
/___/\__/_//_/\___/ v3.3.10-dev
High performance, minimalist Go web framework
https://echo.labstack.com
____________________________________O/_______
                                    O\
â‡¨ http server started on [::]:1323
```
ç°åœ¨æŸ¥çœ‹go.mod å†…å®¹ï¼š
```
module hello

go 1.12

require (
	github.com/labstack/echo v3.3.10+incompatible // indirect
	github.com/labstack/gommon v0.3.0 // indirect
	github.com/sirupsen/logrus v1.4.2
	golang.org/x/crypto v0.0.0-20191011191535-87dc89f01550 // indirect
)
```

#### ç‰¹åˆ«æ³¨æ„
**`go module` å®‰è£… package çš„åŸå‰‡æ˜¯å…ˆæ‹‰æœ€æ–°çš„ `release tag`ï¼Œè‹¥æ— tagåˆ™æ‹‰æœ€æ–°çš„commitï¼Œè¯¦è§ [Moduleså®˜æ–¹ä»‹ç»](https://github.com/golang/go/wiki/Modules)ã€‚ go ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ª go.sum æ–‡ä»¶æ¥è®°å½• dependency treeï¼š**
```
$ cat go.sum
github.com/labstack/echo v3.3.10+incompatible h1:pGRcYk231ExFAyoAjAfD85kQzRJCRI8bbnE7CX5OEgg=
github.com/labstack/echo v3.3.10+incompatible/go.mod h1:0INS7j/VjnFxD4E2wkz67b8cVwCLbBmJyDaka6Cmk1s=
github.com/labstack/gommon v0.2.8 h1:JvRqmeZcfrHC5u6uVleB4NxxNbzx6gpbJiQknDbKQu0=
github.com/labstack/gommon v0.2.8/go.mod h1:/tj9csK2iPSBvn+3NLM9e52usepMtrd5ilFYA+wQNJ4=
github.com/mattn/go-colorable v0.1.1 h1:G1f5SKeVxmagw/IyvzvtZE4Gybcc4Tr1tf7I8z0XgOg=
github.com/mattn/go-colorable v0.1.1/go.mod h1:FuOcm+DKB9mbwrcAfNl7/TZVBZ6rcnceauSikq3lYCQ=
... çœç•¥å¾ˆå¤šè¡Œ
```
### 2.3 æ­£å¸¸è°ƒè¯•
å†æ¬¡æ‰§è¡Œè„šæœ¬ `go run server.go` å‘ç°è·³è¿‡äº†æ£€æŸ¥å¹¶å®‰è£…ä¾èµ–çš„æ­¥éª¤ã€‚

### 2.4 packages å‡çº§
- å¯ä»¥ä½¿ç”¨å‘½ä»¤ `go list -m -u all` æ¥æ£€æŸ¥å¯ä»¥å‡çº§çš„packageï¼Œä½¿ç”¨`go get -u need-upgrade-package` å‡çº§åä¼šå°†æ–°çš„ä¾èµ–ç‰ˆæœ¬æ›´æ–°åˆ°go.mod
- ä¹Ÿå¯ä»¥ä½¿ç”¨ `go get -u `å‡çº§æ‰€æœ‰ä¾èµ–

#### go get å‡çº§
- è¿è¡Œ `go get -u` å°†ä¼šå‡çº§åˆ°æœ€æ–°çš„æ¬¡è¦ç‰ˆæœ¬æˆ–è€…ä¿®è®¢ç‰ˆæœ¬(x.y.z, zæ˜¯ä¿®è®¢ç‰ˆæœ¬å·ï¼Œ yæ˜¯æ¬¡è¦ç‰ˆæœ¬å·)
- è¿è¡Œ `go get -u=patch` å°†ä¼šå‡çº§åˆ°æœ€æ–°çš„ä¿®è®¢ç‰ˆæœ¬
- è¿è¡Œ `go get package@version` å°†ä¼šå‡çº§åˆ°æŒ‡å®šçš„ç‰ˆæœ¬å·version
- è¿è¡Œ`go get`å¦‚æœæœ‰ç‰ˆæœ¬çš„æ›´æ”¹ï¼Œé‚£ä¹ˆgo.modæ–‡ä»¶ä¹Ÿä¼šæ›´æ”¹

## ç¬¬ä¸‰éƒ¨åˆ† æ”¹é€ ç°æœ‰çš„é¡¹ç›®
### 3.1 é¡¹ç›®ç›®å½•å’Œå†…å®¹ï¼š
```
$ tree
.
â”œâ”€â”€ api
â”‚   â””â”€â”€ apis.go
â””â”€â”€ server.go
1 directory, 2 files
```
`server.go` æºç ä¸ºï¼š
```
package main
import (
    api "./api"  // è¿™é‡Œä½¿ç”¨çš„æ˜¯ç›¸å¯¹è·¯å¾„
    "github.com/labstack/echo"
)
func main() {
    e := echo.New()
    e.GET("/", api.HelloWorld)
    e.Logger.Fatal(e.Start(":1323"))
}
```
`api/apis.go` æºç ä¸ºï¼š
```
package api
import (
    "net/http"

    "github.com/labstack/echo"
)
func HelloWorld(c echo.Context) error {
    return c.JSON(http.StatusOK, "hello world")
}
```
### 3.2 æŒ‰ç…§æ­¥éª¤è¿›è¡Œå‡çº§
1. ä½¿ç”¨ go mod init *** åˆå§‹åŒ–go.mod
  ```
  $ go mod init helloworld
  go: creating new go.mod: module helloworld
  ```
2. è¿è¡Œ `go run server.go`
  ```
  go: finding github.com/labstack/gommon/color latest
  go: finding github.com/labstack/gommon/log latest
  go: finding golang.org/x/crypto/acme/autocert latest
  go: finding golang.org/x/crypto/acme latest
  go: finding golang.org/x/crypto latest
  build command-line-arguments: cannot find module for path _/home/gs/helloworld/api
  ```
  é¦–å…ˆè¿˜æ˜¯ä¼šæŸ¥æ‰¾å¹¶ä¸‹è½½å®‰è£…ä¾èµ–ï¼Œç„¶åè¿è¡Œè„šæœ¬ `server.go`ï¼Œè¿™é‡Œä¼šæŠ›å‡ºä¸€ä¸ªé”™è¯¯ï¼š
  ```
  build command-line-arguments: cannot find module for path _/home/gs/helloworld/api
  ```
  ä½†æ˜¯`go.mod` å·²ç»æ›´æ–°ï¼š
  ```
  $ cat go.mod
  module helloworld
  go 1.12
  require (
          github.com/labstack/echo v3.3.10+incompatible // indirect
          github.com/labstack/gommon v0.2.8 // indirect
          github.com/mattn/go-colorable v0.1.1 // indirect
          github.com/mattn/go-isatty v0.0.7 // indirect
          github.com/valyala/fasttemplate v1.0.0 // indirect
          golang.org/x/crypto v0.0.0-20190313024323-a1f597ede03a // indirect
  )
  ```

### 3.3 åœ¨æ–°çš„module ä¸èƒ½ä½¿ç”¨ç›¸å¯¹è·¯å¾„å¼•å…¥package
> é‚£ä¸ºä»€ä¹ˆä¼šæŠ›å‡ºè¿™ä¸ªé”™è¯¯å‘¢ï¼Ÿ

è¿™æ˜¯å› ä¸º `server.go` ä¸­ä½¿ç”¨ `internal package` çš„æ–¹æ³•è·Ÿä»¥å‰å·²ç»ä¸åŒäº†ï¼Œç”±äº `go.mod`ä¼šæ‰«æåŒå·¥ä½œç›®å½•ä¸‹æ‰€æœ‰ package å¹¶ä¸”å˜æ›´å¼•å…¥æ–¹æ³•ï¼Œå¿…é¡»å°†`helloworld`å½“æˆè·¯å¾„çš„å‰ç¼€ï¼Œä¹Ÿå°±æ˜¯éœ€è¦å†™æˆ  `import helloworld/api`ï¼Œä»¥å¾€ `GOPATH/dep` æ¨¡å¼å…è®¸çš„ `import ./api` å·²ç»å¤±æ•ˆï¼Œè¯¦æƒ…å¯ä»¥æŸ¥çœ‹è¿™ä¸ª [issue](https://github.com/golang/go/issues/26645)ã€‚

æ‰€ä»¥`server.go` éœ€è¦æ”¹å†™æˆï¼š
```
package main
import (
    api "helloworld/api"  // è¿™æ˜¯æ›´æ–°åçš„å¼•å…¥æ–¹æ³•
    "github.com/labstack/echo"
)
func main() {
    e := echo.New()
    e.GET("/", api.HelloWorld)
    e.Logger.Fatal(e.Start(":1323"))
}
```

> ä¸€ä¸ªå°å‘ï¼šå¼€å§‹åœ¨golang1.11 ä¸‹ä½¿ç”¨go mod é‡åˆ°è¿‡ go build github.com/valyala/fasttemplate: module requires go 1.12 è¿™ç§é”™è¯¯ï¼Œé‡åˆ°ç±»ä¼¼è¿™ç§éœ€è¦å‡çº§åˆ°1.12 çš„é—®é¢˜ï¼Œç›´æ¥å‡çº§golang1.12 å°±å¥½äº†ã€‚å¹¸äºæ˜¯åœ¨1.12 å‘å¸ƒåæ‰å°è¯•çš„go mod ğŸ¤·â€â™‚ï¸

### 3.4 åˆ°è¿™é‡Œå°±å’Œæ–°åˆ›å»ºä¸€ä¸ªé¡¹ç›®æ²¡ä»€ä¹ˆåŒºåˆ«äº†

## ç¬¬å››éƒ¨åˆ† å…¶ä»–è®²è¿°
### 4.1 ä½¿ç”¨replaceæ›¿æ¢æ— æ³•ç›´æ¥è·å–çš„package
ç”±äºæŸäº›å·²çŸ¥çš„åŸå› ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„packageéƒ½èƒ½æˆåŠŸä¸‹è½½ï¼Œæ¯”å¦‚ï¼š`golang.org`ä¸‹çš„åŒ…ã€‚
modules å¯ä»¥é€šè¿‡åœ¨ `go.mod` æ–‡ä»¶ä¸­ä½¿ç”¨ replace æŒ‡ä»¤æ›¿æ¢æˆ`github`ä¸Šå¯¹åº”çš„åº“ï¼Œæ¯”å¦‚ï¼š
```
replace (
	golang.org/x/crypto v0.0.0-20190313024323-a1f597ede03a => github.com/golang/crypto v0.0.0-20190313024323-a1f597ede03a
)
```
æˆ–è€…
```
replace golang.org/x/crypto v0.0.0-20190313024323-a1f597ede03a => github.com/golang/crypto
```

### 4.2 Golang IDE æ”¯æŒ go module

macä¸‹ Golang -> Perferences -> Go -> Go Modules(vgo) -> Enable Go Modules (vgo) integrationæ‰“å‹¾
é…ç½® ä»£ç†ï¼š
```
https://goproxy.io
```
